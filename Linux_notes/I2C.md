I²C
---

### 一、I²C基本概念

I2C总线是由Philips公司开发的一种简单、双向二线制同步串行总线。  
**主机：** 主机可以用作主机发送器或主机接收器  
**从机：** 被主机寻址的器件  
**发送器：** 发送数据到总线的器件  
**接收器：** 从总线接收数据的器件  
**多主机：** 同时有多于一个主机尝试控制总线，但不破坏报文。两个或多个主机同时发起数据传输时，可以通过冲突检测或仲裁来防止数据被破坏。  
**仲裁：** 是一个在有多个主机同时尝试控制总线，但只允许其中一个控制总线并使报文不被破坏的过程  
**同步：** 两个或多个器件同步时钟信号的过程  
**速度：** 串行的8位双向数据传输，位速率在标准模式下可达100Kbit/s，在快速模式下可达400Kbit/s，在高速模式下可达3.4Mbit/s。  
**同时连接的设备数量：**  
硬件上：连接到同一总线上得IC数量只受到总线的最大电容400pF的限制。片上得滤波器可以增加抗干扰功能，保证数据的完整。  
软件上：软件上I²C的设备地址是7位的，因此可以 **连接128个设备**。

### 二、硬件结构

![image](C:TsinghuaNotesLinux_notes主机接收数据.PNG) 每一个I²C总线器件内部的SDA、SCL引脚电路结构都是一样的，引脚的输出驱动与输入缓冲连在一起。其中输出为漏极开路的场效应管、输入缓冲为一只高输入阻抗的同相器。  
1、由于SDA、SCL为漏极开路结构，借助于外部的上拉电阻实现了信号的“线与”逻辑；  
2、引脚在输出信号的同时还将引脚上的电平进行检测，检测是否与刚才输出一致。为“时钟同步”和“总线仲裁”提供硬件基础。

### 三、时钟同步

如果从机希望主机降低传送速度可以通过将SCL主动拉低延长其低电平时间的方法来通知主机，当主机在准备下一次传送发现SCL的电平被拉低时就进行等待，直至从机完成操作并释放SCL线的控制控制权。这样以来，主机实际上受到从机的时钟同步控制。可见SCL线上的低电平是由时钟低电平最长的器件决定；高电平的时间由高电平时间最短的器件决定。这就是时钟同步，它解决了I2C总线的速度同步问题。**这就是硬件上线与的作用。**

### 四、工作原理

#### 4.1、通讯要点

1、以启动信号START来掌管总线，以停止信号STOP来释放总线；  
2、每次通讯以START开始，以STOP结束；  
3、启动START后紧接着发送一个地址字节，其中7位被控器件的地址码，一位位读/写控制位R/W，R/W位为0表示由主控向被控器件写数据，R/W为1表示由主控向被控器件读数据；  
4、当被控器件检测到收到的地址与自己的地址相同时，在第9个时钟间反馈应答信号；  
5、每个数据字节在传送时都是高位(MSB)在前；

#### 4.2、I²C的信号类型

I²C总线在传送数据过程中共有3种类型信号：开始信号、结束信号、应答信号。  
![image](C:UsersTsinghuaDesktop1.png) 1、START信号：当SCL为高期间，SDA由高到低的跳变；  
2、STOP信号：当SCL为高期间，SDA由低到高的跳变；  
![image](C:UsersTsinghuaDesktop2.png)  
3、ACK响应信号：接收器在接收到8位数据后，在第9个时钟周期，拉低SDA电平。发送器在每发送一个字节，就在时钟脉冲9期间释放数据线，由接收器反馈一个应答信号。应答信号为低电平时，规定为有效应答(ACK简称应答位)，表示接收器已经成功接收了该字节；应答信号为高电平时，规定为非应答位(NACK),一般表示接收器接收该字节没有成功。**对于反馈有效应答位ACK的要求是，接收器在第9个时钟脉冲之前的低电平期间将SDA线拉低，并且确保在该时钟的高电平期间为稳定的低电平。**  
如果接收器是主控器，则在它收到最后一个字节后，发送一个NACK信号，以通知被控制发送器结束数据发送，并释放SDA线，以便主控接收器发送一个停止信号。

#### 4.3、空闲状态

I²C总线总线的SDA和SCL两条信号线同时处于高电平时，规定为总线的空闲状态。此时各个器件的输出级场效应管均处在截止状态，即释放总线，由两条信号线各自的上拉电阻把电平拉高。

#### 4.4、数据的有效性

I²C总线在进行数据传送时，时钟信号为高电平期间，数据线上得数据必须保持稳定，只有在时钟线上的信号为低电平期间，数据线上的高电平或低电平状态才允许变化。  
![image](C:UsersTsinghuaDesktop3.png)  
数据是在SCL为高电平的时候进行读写的。？

#### 4.5、I²C总线的数据传输流程

![image](C:UsersTsinghuaDesktop4.png)  
主机发送数据  
![image]()  
主机接收数据  
发送SDA线上的每个字节必须是8位的，每次传输可以发送的字节数量不受限制。每个字节后必须跟一个响应位。首先传输的是数据的最高位(MSB)。如果从机要完成一些其他功能后（例如一个内部中断服务程序）才能继续接收或发送下一个字节，从机可以拉低SCL迫使主机进入等待状态。当从机准备好接收下一个数据并释放SCL后，数据传输继续。如果主机在传输数据期间也要完成一些其他功能（例如一个内部中断服务程序）也可以拉低SCL以占住总线。  
启动一个传输时，主机先发出S信号，然后发出8位数据。这8位数据中前7位为从机的地址，第8位表示传输的方向(0表示W，1表示R)。被选中的从机发出响应信号。紧接着传输一系列字节及其响应位。最后主机发出结束信号结束本次传输。  
*并非每传输8位数据后，都会有ACK信号，有以下3种例外*  
 > 1、单从机不能响应从机地址时(例如它正忙于其他事而无法响应I²C总线的操作，或这个地址没有对应的从机)，在第9个SCL周期内SDA线没有被拉低，即没有ACK信号。这时，主机发出一个停止信号终止传输或者重新发出一个开始信号开始新的传输。  
> 2、如果从机接收器在传输过程中不能接收更多的数据时，它也不会发出ACK信号。这样主机就可以意识到这点，，从而主机发出一个停止信号终止传输或者重新发出一个开始信号开始新的传输。  
> 3、主机接收器在接收到最后一个字节后，也不会发出ACK信号。于是，从机发送器释放SDA线，以允许主机发出结束信号结束传输。

### 总线死锁原因分析

I²C总线在写操作过程中，主机在产生启动信号控制SCL产生8个时钟脉冲，然后拉低SCL信号为低电平，在这个时候，从机输出应答信号，将SDA信号拉为低电平。如果这个时候主机异常复位，SCL就会被释放为高电平。此时，如果从机没有复位，就会继续I²C的应答，将SDA一直拉为低电平，直到SCL变为低电平，才会结束应答信号。而对于主机来说，复位后检测SCL和SDA信号，如果发现SDA信号为低电平，则会认为I²C总线会被占用，会一直等待SCL和SDA信号变为高电平。这样，主机等待从机释放SDA信号为低电平，同时从机又在等待主机将SCL信号拉低以释放应答信号，两者相互等待，I²C总线进入一种死锁状态。同样，当I²C进行读操作时，从机应答后输出数据，如果在这个时刻主机异常复位而此时从机输出的数据位正好为0，也会导致I²C总线进入死锁状态。  
**解决方案：**  
1、将从机的电源设计为可控，当发生总线死锁的时将从机复位 2、可以在从机的程序中加入监测功能，如果总线长时间被拉低则释放对总线的控制  
3、在主机中增加I²C总线恢复程序。每次主机复位后，如果检测到SDA被拉低，则控制SCL产生<=9个时钟脉冲(针对8位数据的情况)，每发送一个时钟脉冲就检测SDA是否被释放，如果SDA已经被释放就再模拟产生一个停止信号，这样从机就可以完成被挂起的读写操作，从死锁状态中恢复过来。这种方法有一定的局限性，因为大部分主机的I²C模块由内置的硬件电路来实现，软件并不能够直接控制SCL信号模拟产生需要的时钟脉冲。
