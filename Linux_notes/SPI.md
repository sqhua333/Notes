SPI
---

### 一、SPI简介

#### 1.1、什么是SPI

SPI是串行外设接口(Serial Peripheral Interface)的缩写。是Motorola公司推出的一种同步串行接口技术，是一种高速的，全双工，同步的通信总线。

#### 1.2、SPI优点

支持全双工通信，通信简单，数据传输速率快。

#### 1.3、缺点

没有指定的流控制，没有应答机制确认是否接收到数据，所以跟I²C总线协议比较数据可靠性上有一定的缺陷。

#### 1.4、特点

a、高速、同步、全双工、非差分、总线式  
b、主从机通信模式  
c、无需上拉，内部有处理  
d、SPI每多一个从设备就需要占用一个IO，SPI速度一般需要看具体的器件。  
e、每个数据字节在传送时都是高位(MSB)在前，SPI设备里面有描述。  
f、在SPI总线上，某一时刻可以出现多个从机，但只能存在一个主机，主机通过片选线来确定要通信的从机。这就要求从机的MISO口具有三态特性，使得该口线在器件未被选通时表现为高阻抗。

### 二、SPI协议通信时序

#### 2.1、SPI设备连接图

![image](sdf)

#### 2.2、SPI通信原理

SPI是一个环形总线结构，SPI通信原理很简单，它以主从方式工作，这种模式通常有一个主设备或多个从设备，需要4根线，事实上3根也可以(单向传输)。也是所有基于SPI的设备共有的，它们是SDI(数据输入)/MISO(主输入从输出)，SDO(数据输出)/MOSI(主输出从输入)，SCLK(时钟)，CS(片选)。  
> a、SCLK - 时钟信号，由主设备产生  
> b、CS/SS - 从设备使能信号，由主设备控制。当有多个从设备接入到主设备时，主设备通过使能CS/SS选择与之要通信的从设备。

#### 2.3、SPI通信模式

SPI通信有四种不同的模式，从设备有可能在出厂时就已经被设定好了某种模式，也有可能是可以配置的。可以通过主设备的SPI模式进行配置。  
>Mode0: CPOL = 0; CPHA = 0;  
>Mode1: CPOL = 0; CPHA = 1;  
>Mode2: CPOL = 1; CPHA = 0;  
>Mode3: CPOL = 1; CPHA = 1;

**CPOL(时钟极性) - 配置SCLK的电平出于哪种状态时是空闲或者有效态**  
a、CPOL=0，表示SCLK=0时处于空闲状态  
b、CPOL=1，表示SCLK=1时处于空闲状态  
**CPHA(时钟相位) - 配置数据采样是在第几个边沿**  
a、CPHA=0，表示数据采样时在第一个边沿，数据发送在第二个边沿  
b、CPHA=1，表示数据采样是在第二个边沿，数据发送在第一个边沿  
![image](sdf)  
>PS：我们的主设备能够控制时钟，因为我们的SPI通信并不像UART或IIC通信那样有专门的通信周期，有专门的通信起始信号，有专门的结束信号；  
>因此，SPI协议能够控制时钟信号线，当没有数据交流的时候我们的时钟线要么是保持高电平要么是保持低电平。

#### 2.4 主从器件是如何输出bit1数据的

假设时钟极性CPOL与时钟相位CPHA都被配置为0，从2.3节中插图来分析：  
![image](sdf)  
SCK的第一个时钟周期，时钟的上升沿采样数据，在时钟的下降沿输出数据。那主器件的输出口(MOSI)输出的bit1，在时钟的上升沿被从器件采样，那主器件是在何时刻输出bit1的呢？bit的输出时刻实际上在SCK信号有效前，比SCK上升沿还要早半个时钟周期。bit的输出时刻与SEL信号没有关系。  
![image](sdf)  
这张图就可以很清楚的看出主从器件的bit1是怎样输出的。  
再来看从器件，主器件的输入口MISO同样是在时钟的上升沿采样从器件输出的bit1的，那从器件又是何时刻输出bit1的呢。从器件是在sel信号有效后，立即输出bit1，尽管此时SCK信号还没有起效。
